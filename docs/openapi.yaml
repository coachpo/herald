openapi: 3.1.0
info:
  title: Beacon Spear API (v1.0)
  version: 1.0.0
  description: |
    Breaking upgrade from v0.2. No backward compatibility.

    Beacon Spear provides:
    - a public ingest endpoint: `POST /api/ingest/{endpoint_id}` (requires `X-Beacon-Ingest-Key`, accepts structured JSON)
    - authenticated JSON APIs for the web dashboard under `/api/*`

    Authenticated endpoints use JWT access tokens via `Authorization: Bearer <token>`.
servers:
  - url: https://example.com
tags:
  - name: auth
  - name: ingest
  - name: ingest_endpoints
  - name: messages
  - name: channels
  - name: rules
  - name: deliveries
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    ingestKeyAuth:
      type: apiKey
      in: header
      name: X-Beacon-Ingest-Key
  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    EndpointIdParam:
      name: endpoint_id
      in: path
      required: true
      schema:
        type: string
        pattern: "^[0-9a-fA-F]{32}$"
  schemas:
    Error:
      type: object
      additionalProperties: false
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
      required: [code, message]
    UUID:
      type: string
      format: uuid
    Timestamp:
      type: string
      format: date-time
    User:
      type: object
      additionalProperties: false
      properties:
        id: { $ref: "#/components/schemas/UUID" }
        email: { type: string, format: email }
        email_verified_at:
          anyOf:
            - { $ref: "#/components/schemas/Timestamp" }
            - { type: "null" }
        created_at: { $ref: "#/components/schemas/Timestamp" }
      required: [id, email, email_verified_at, created_at]
    SignupRequest:
      type: object
      additionalProperties: false
      properties:
        email: { type: string, format: email }
        password:
          type: string
          minLength: 8
      required: [email, password]
    LoginRequest:
      type: object
      additionalProperties: false
      properties:
        email: { type: string, format: email }
        password: { type: string }
      required: [email, password]
    ForgotPasswordRequest:
      type: object
      additionalProperties: false
      properties:
        email: { type: string, format: email }
      required: [email]
    ResetPasswordRequest:
      type: object
      additionalProperties: false
      properties:
        token: { type: string }
        new_password:
          type: string
          minLength: 8
      required: [token, new_password]
    VerifyEmailRequest:
      type: object
      additionalProperties: false
      properties:
        token: { type: string }
      required: [token]
    ChangeEmailRequest:
      type: object
      additionalProperties: false
      properties:
        new_email: { type: string, format: email }
      required: [new_email]
    ChangePasswordRequest:
      type: object
      additionalProperties: false
      properties:
        old_password: { type: string }
        new_password:
          type: string
          minLength: 8
      required: [old_password, new_password]
    DeleteAccountRequest:
      type: object
      additionalProperties: false
      properties:
        password: { type: string }
        confirm:
          type: string
          description: Must equal "DELETE".
      required: [password, confirm]
    IngestEndpoint:
      type: object
      additionalProperties: false
      properties:
        id: { $ref: "#/components/schemas/UUID" }
        name: { type: string }
        created_at: { $ref: "#/components/schemas/Timestamp" }
        last_used_at:
          anyOf:
            - { $ref: "#/components/schemas/Timestamp" }
            - { type: "null" }
        revoked_at:
          anyOf:
            - { $ref: "#/components/schemas/Timestamp" }
            - { type: "null" }
      required: [id, name, created_at, last_used_at, revoked_at]
    IngestEndpointCreateRequest:
      type: object
      additionalProperties: false
      properties:
        name: { type: string }
      required: [name]
    IngestEndpointCreateResponse:
      type: object
      additionalProperties: false
      properties:
        endpoint: { $ref: "#/components/schemas/IngestEndpoint" }
        ingest_key:
          type: string
          description: Secret ingest key shown only once at creation time.
        ingest_url:
          type: string
      required: [endpoint, ingest_key, ingest_url]
    MessageSummary:
      type: object
      additionalProperties: false
      properties:
        id: { $ref: "#/components/schemas/UUID" }
        ingest_endpoint_id: { $ref: "#/components/schemas/UUID" }
        received_at: { $ref: "#/components/schemas/Timestamp" }
        title:
          anyOf:
            - { type: string }
            - { type: "null" }
        body_preview: { type: string }
        group:
          anyOf:
            - { type: string }
            - { type: "null" }
        priority:
          type: integer
          minimum: 1
          maximum: 5
        tags:
          type: array
          items: { type: string }
        deliveries:
          type: object
          additionalProperties: false
          properties:
            queued: { type: integer }
            sending: { type: integer }
            retry: { type: integer }
            sent: { type: integer }
            failed: { type: integer }
          required: [queued, sending, retry, sent, failed]
      required: [id, ingest_endpoint_id, received_at, title, body_preview, group, priority, tags, deliveries]
    MessageDetail:
      type: object
      additionalProperties: false
      properties:
        id: { $ref: "#/components/schemas/UUID" }
        ingest_endpoint_id: { $ref: "#/components/schemas/UUID" }
        received_at: { $ref: "#/components/schemas/Timestamp" }
        title:
          anyOf:
            - { type: string }
            - { type: "null" }
        body: { type: string }
        group:
          anyOf:
            - { type: string }
            - { type: "null" }
        priority:
          type: integer
          minimum: 1
          maximum: 5
        tags:
          type: array
          items: { type: string }
        url:
          anyOf:
            - { type: string }
            - { type: "null" }
        extras:
          type: object
          additionalProperties: { type: string }
        content_type:
          anyOf:
            - { type: string }
            - { type: "null" }
        headers:
          type: object
          additionalProperties:
            type: string
        query:
          type: object
          additionalProperties:
            type: string
        remote_ip: { type: string }
        user_agent:
          anyOf:
            - { type: string }
            - { type: "null" }
        deleted_at:
          anyOf:
            - { $ref: "#/components/schemas/Timestamp" }
            - { type: "null" }
      required: [id, ingest_endpoint_id, received_at, title, body, group, priority, tags, url, extras, content_type, headers, query, remote_ip, user_agent, deleted_at]
    BatchDeleteRequest:
      type: object
      additionalProperties: false
      properties:
        older_than_days:
          type: integer
          minimum: 1
          maximum: 36500
        ingest_endpoint_id:
          anyOf:
            - { $ref: "#/components/schemas/UUID" }
            - { type: "null" }
      required: [older_than_days]
    BatchDeleteResponse:
      type: object
      additionalProperties: false
      properties:
        deleted_count: { type: integer }
      required: [deleted_count]
    Channel:
      type: object
      additionalProperties: false
      properties:
        id: { $ref: "#/components/schemas/UUID" }
        type:
          type: string
          enum: [bark, ntfy, mqtt]
        name: { type: string }
        created_at: { $ref: "#/components/schemas/Timestamp" }
        disabled_at:
          anyOf:
            - { $ref: "#/components/schemas/Timestamp" }
            - { type: "null" }
      required: [id, type, name, created_at, disabled_at]
    BarkChannelConfig:
      type: object
      additionalProperties: false
      properties:
        server_base_url:
          type: string
          description: Base URL of the Bark server (e.g. https://api.day.app or your self-hosted base).
        device_key:
          type: string
          description: Bark device key.
        device_keys:
          type: array
          items: { type: string }
          description: Optional batch keys (Bark v2).
        default_payload_json:
          type: object
          description: Arbitrary Bark v2 fields merged into every push.
      required: [server_base_url]
    BarkChannelUpsertRequest:
      type: object
      additionalProperties: false
      properties:
        type:
          type: string
          enum: [bark]
        name: { type: string }
        config: { $ref: "#/components/schemas/BarkChannelConfig" }
      required: [type, name, config]
    NtfyChannelConfig:
      type: object
      additionalProperties: false
      properties:
        server_base_url:
          type: string
          description: Base URL of the ntfy server (e.g. https://ntfy.sh).
        topic:
          type: string
          description: Topic name to publish to.
        access_token:
          anyOf:
            - { type: string }
            - { type: "null" }
          description: Optional bearer token.
        username:
          anyOf:
            - { type: string }
            - { type: "null" }
          description: Optional basic auth username (must be paired with password).
        password:
          anyOf:
            - { type: string }
            - { type: "null" }
          description: Optional basic auth password (must be paired with username).
        default_headers_json:
          type: object
          description: Optional headers merged into every publish request.
      required: [server_base_url, topic]
    NtfyChannelUpsertRequest:
      type: object
      additionalProperties: false
      properties:
        type:
          type: string
          enum: [ntfy]
        name: { type: string }
        config: { $ref: "#/components/schemas/NtfyChannelConfig" }
      required: [type, name, config]
    MqttChannelConfig:
      type: object
      additionalProperties: false
      properties:
        broker_host:
          type: string
          description: MQTT broker host.
        broker_port:
          anyOf:
            - { type: integer, minimum: 1, maximum: 65535 }
            - { type: "null" }
          description: MQTT broker port (default 1883).
        topic:
          type: string
          description: MQTT topic.
        username:
          anyOf:
            - { type: string }
            - { type: "null" }
        password:
          anyOf:
            - { type: string }
            - { type: "null" }
        tls:
          anyOf:
            - { type: boolean }
            - { type: "null" }
        tls_insecure:
          anyOf:
            - { type: boolean }
            - { type: "null" }
          description: If true, disables TLS certificate verification.
        qos:
          anyOf:
            - { type: integer, minimum: 0, maximum: 2 }
            - { type: "null" }
        retain:
          anyOf:
            - { type: boolean }
            - { type: "null" }
        client_id:
          anyOf:
            - { type: string }
            - { type: "null" }
        keepalive_seconds:
          anyOf:
            - { type: integer, minimum: 1, maximum: 3600 }
            - { type: "null" }
      required: [broker_host, topic]
    MqttChannelUpsertRequest:
      type: object
      additionalProperties: false
      properties:
        type:
          type: string
          enum: [mqtt]
        name: { type: string }
        config: { $ref: "#/components/schemas/MqttChannelConfig" }
      required: [type, name, config]
    BarkChannelDetail:
      type: object
      additionalProperties: false
      properties:
        channel: { $ref: "#/components/schemas/Channel" }
        config: { $ref: "#/components/schemas/BarkChannelConfig" }
      required: [channel, config]
    NtfyChannelDetail:
      type: object
      additionalProperties: false
      properties:
        channel: { $ref: "#/components/schemas/Channel" }
        config: { $ref: "#/components/schemas/NtfyChannelConfig" }
      required: [channel, config]
    MqttChannelDetail:
      type: object
      additionalProperties: false
      properties:
        channel: { $ref: "#/components/schemas/Channel" }
        config: { $ref: "#/components/schemas/MqttChannelConfig" }
      required: [channel, config]
    ChannelUpsertRequest:
      oneOf:
        - { $ref: "#/components/schemas/BarkChannelUpsertRequest" }
        - { $ref: "#/components/schemas/NtfyChannelUpsertRequest" }
        - { $ref: "#/components/schemas/MqttChannelUpsertRequest" }
    ChannelDetail:
      oneOf:
        - { $ref: "#/components/schemas/BarkChannelDetail" }
        - { $ref: "#/components/schemas/NtfyChannelDetail" }
        - { $ref: "#/components/schemas/MqttChannelDetail" }
    Rule:
      type: object
      additionalProperties: false
      properties:
        id: { $ref: "#/components/schemas/UUID" }
        name: { type: string }
        enabled: { type: boolean }
        channel_id: { $ref: "#/components/schemas/UUID" }
        filter:
          $ref: "#/components/schemas/RuleFilter"
        payload_template:
          type: object
          description: Generic payload template used by the channel provider. Supports {{variable}} substitution.
          additionalProperties: true
        created_at: { $ref: "#/components/schemas/Timestamp" }
        updated_at: { $ref: "#/components/schemas/Timestamp" }
      required: [id, name, enabled, channel_id, filter, payload_template, created_at, updated_at]
    RuleFilter:
      type: object
      additionalProperties: false
      properties:
        ingest_endpoint_ids:
          anyOf:
            - type: array
              items: { $ref: "#/components/schemas/UUID" }
            - type: "null"
        body:
          anyOf:
            - $ref: "#/components/schemas/BodyFilter"
            - type: "null"
        priority:
          anyOf:
            - $ref: "#/components/schemas/PriorityFilter"
            - type: "null"
        tags:
          anyOf:
            - type: array
              items: { type: string }
              description: Message must have at least one of these tags (any-of match).
            - type: "null"
        group:
          anyOf:
            - type: string
              description: Exact match on message group.
            - type: "null"
      required: []
    BodyFilter:
      type: object
      additionalProperties: false
      properties:
        contains:
          anyOf:
            - type: array
              items: { type: string }
            - type: "null"
          description: At least one substring must be present in body (case-insensitive).
        regex:
          anyOf:
            - { type: string }
            - { type: "null" }
          description: Regex pattern that must match body.
    PriorityFilter:
      type: object
      additionalProperties: false
      properties:
        min:
          anyOf:
            - type: integer
              minimum: 1
              maximum: 5
            - type: "null"
          description: Message priority must be >= min.
        max:
          anyOf:
            - type: integer
              minimum: 1
              maximum: 5
            - type: "null"
          description: Message priority must be <= max.
    RuleUpsertRequest:
      type: object
      additionalProperties: false
      properties:
        name: { type: string }
        enabled: { type: boolean }
        channel_id: { $ref: "#/components/schemas/UUID" }
        filter: { $ref: "#/components/schemas/RuleFilter" }
        payload_template:
          type: object
          additionalProperties: true
          description: Payload template with {{variable}} substitution.
      required: [name, enabled, channel_id, filter]
    RuleTestRequest:
      type: object
      additionalProperties: false
      properties:
        ingest_endpoint_id: { $ref: "#/components/schemas/UUID" }
        payload:
          $ref: "#/components/schemas/IngestPayload"
      required: [ingest_endpoint_id, payload]
    IngestPayload:
      type: object
      additionalProperties: false
      properties:
        title:
          anyOf:
            - { type: string }
            - { type: "null" }
        body: { type: string }
        group:
          anyOf:
            - { type: string }
            - { type: "null" }
        priority:
          type: integer
          minimum: 1
          maximum: 5
          default: 3
        tags:
          type: array
          items: { type: string }
          default: []
        url:
          anyOf:
            - { type: string }
            - { type: "null" }
        extras:
          type: object
          additionalProperties: { type: string }
          default: {}
      required: [body]
    RuleTestResponse:
      type: object
      additionalProperties: false
      properties:
        matches: { type: boolean }
        channel_type:
          type: string
          enum: [bark, ntfy, mqtt]
        rendered_payload:
          type: object
          additionalProperties: true
      required: [matches, channel_type, rendered_payload]
    RulesTestMatch:
      type: object
      additionalProperties: false
      properties:
        rule: { $ref: "#/components/schemas/Rule" }
        channel: { $ref: "#/components/schemas/Channel" }
        channel_type:
          type: string
          enum: [bark, ntfy, mqtt]
        rendered_payload:
          type: object
          additionalProperties: true
      required: [rule, channel, channel_type, rendered_payload]
    RulesTestResponse:
      type: object
      additionalProperties: false
      properties:
        matched_count: { type: integer }
        total_rules: { type: integer }
        matches:
          type: array
          items: { $ref: "#/components/schemas/RulesTestMatch" }
      required: [matched_count, total_rules, matches]
    ChannelTestRequest:
      type: object
      additionalProperties: false
      properties:
        title:
          anyOf:
            - { type: string }
            - { type: "null" }
        body:
          anyOf:
            - { type: string }
            - { type: "null" }
        payload_json:
          anyOf:
            - type: object
              additionalProperties: true
            - { type: "null" }
      required: []
    ChannelTestResponse:
      type: object
      additionalProperties: false
      properties:
        ok: { type: boolean }
        channel_id: { $ref: "#/components/schemas/UUID" }
        channel_type:
          type: string
          enum: [bark, ntfy, mqtt]
        provider_response:
          type: object
          additionalProperties: true
      required: [ok, channel_id, channel_type, provider_response]
    Delivery:
      type: object
      additionalProperties: false
      properties:
        id: { $ref: "#/components/schemas/UUID" }
        message_id: { $ref: "#/components/schemas/UUID" }
        rule_id: { $ref: "#/components/schemas/UUID" }
        channel_id: { $ref: "#/components/schemas/UUID" }
        status:
          type: string
          enum: [queued, sending, retry, sent, failed]
        attempt_count: { type: integer }
        next_attempt_at:
          anyOf:
            - { $ref: "#/components/schemas/Timestamp" }
            - { type: "null" }
        sent_at:
          anyOf:
            - { $ref: "#/components/schemas/Timestamp" }
            - { type: "null" }
        last_error:
          anyOf:
            - { type: string }
            - { type: "null" }
        provider_response:
          anyOf:
            - type: object
            - type: "null"
      required: [id, message_id, rule_id, channel_id, status, attempt_count, next_attempt_at, sent_at, last_error, provider_response]
paths:
  /api/auth/signup:
    post:
      tags: [auth]
      summary: Sign up
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SignupRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  user: { $ref: "#/components/schemas/User" }
                required: [user]
        "400":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/auth/login:
    post:
      tags: [auth]
      summary: Login (JWT)
      description: |
        Returns a short-lived access token (JWT) and a refresh token.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/LoginRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  access_token: { type: string }
                  refresh_token: { type: string }
                  user: { $ref: "#/components/schemas/User" }
                required: [access_token, refresh_token, user]
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/auth/refresh:
    post:
      tags: [auth]
      summary: Refresh access token
      description: |
        Uses a refresh token to mint a new short-lived access token (JWT).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              properties:
                refresh_token: { type: string }
              required: [refresh_token]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  access_token: { type: string }
                  refresh_token: { type: string }
                  user: { $ref: "#/components/schemas/User" }
                required: [access_token, refresh_token, user]
        "401":
          description: Not authenticated (missing/invalid refresh token)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/auth/logout:
    post:
      tags: [auth]
      summary: Logout (clears session)
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              properties:
                refresh_token: { type: string }
      responses:
        "204":
          description: Logged out
  /api/auth/me:
    get:
      tags: [auth]
      security: [{ bearerAuth: [] }]
      summary: Current user
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  user: { $ref: "#/components/schemas/User" }
                required: [user]
        "401":
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/auth/resend-verification:
    post:
      tags: [auth]
      security: [{ bearerAuth: [] }]
      summary: Resend verification email
      responses:
        "204":
          description: Sent (or no-op if already verified)
  /api/auth/verify-email:
    post:
      tags: [auth]
      summary: Verify email using token
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/VerifyEmailRequest" }
      responses:
        "204":
          description: Verified
        "400":
          description: Invalid or expired token
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/auth/forgot-password:
    post:
      tags: [auth]
      summary: Request password reset email
      description: |
        Returns 204 regardless of whether the email exists to avoid user enumeration.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ForgotPasswordRequest" }
      responses:
        "204":
          description: Sent (or no-op)
  /api/auth/reset-password:
    post:
      tags: [auth]
      summary: Reset password using token
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ResetPasswordRequest" }
      responses:
        "204":
          description: Password updated
        "400":
          description: Invalid or expired token
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/auth/change-email:
    post:
      tags: [auth]
      security: [{ bearerAuth: [] }]
      summary: Change email (requires re-verification)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ChangeEmailRequest" }
      responses:
        "200":
          description: Updated (verification required again)
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  user: { $ref: "#/components/schemas/User" }
                required: [user]
  /api/auth/change-password:
    post:
      tags: [auth]
      security: [{ bearerAuth: [] }]
      summary: Change password
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ChangePasswordRequest" }
      responses:
        "204":
          description: Updated
  /api/auth/delete-account:
    post:
      tags: [auth]
      security: [{ bearerAuth: [] }]
      summary: Delete account
      description: |
        Irreversible. Hard-deletes the user and cascades deletion of owned data.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DeleteAccountRequest" }
      responses:
        "204":
          description: Deleted
        "400":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "401":
          description: Not authenticated or invalid credentials
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/ingest/{endpoint_id}:
    post:
      tags: [ingest]
      summary: Ingest a structured message
      description: |
        Accepts a structured JSON payload with notification fields.
        Requires Content-Type: application/json. Max size 1MB.
        Only `body` is required; all other fields are optional.
      security: [{ ingestKeyAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/EndpointIdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestPayload"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  message_id: { $ref: "#/components/schemas/UUID" }
                required: [message_id]
        "400":
          description: Invalid JSON or invalid UTF-8
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "401":
          description: Auth failure
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "403":
          description: User not verified or disabled
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "413":
          description: Payload too large
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "415":
          description: Content-Type is not application/json
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "422":
          description: Validation error (missing body, invalid priority, unknown keys, etc.)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/ingest-endpoints:
    get:
      tags: [ingest_endpoints]
      security: [{ bearerAuth: [] }]
      summary: List ingest endpoints
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  endpoints:
                    type: array
                    items: { $ref: "#/components/schemas/IngestEndpoint" }
                required: [endpoints]
    post:
      tags: [ingest_endpoints]
      security: [{ bearerAuth: [] }]
      summary: Create ingest endpoint
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/IngestEndpointCreateRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/IngestEndpointCreateResponse" }
  /api/ingest-endpoints/{id}/revoke:
    post:
      tags: [ingest_endpoints]
      security: [{ bearerAuth: [] }]
      summary: Revoke an ingest endpoint
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "204":
          description: Revoked
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/ingest-endpoints/{id}:
    delete:
      tags: [ingest_endpoints]
      security: [{ bearerAuth: [] }]
      summary: Archive an ingest endpoint
      description: |
        Archives (hides) the endpoint without deleting message history.
        Archiving also revokes the endpoint.
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "204":
          description: Archived
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/messages:
    get:
      tags: [messages]
      security: [{ bearerAuth: [] }]
      summary: List messages
      parameters:
        - name: ingest_endpoint_id
          in: query
          required: false
          schema: { $ref: "#/components/schemas/UUID" }
        - name: q
          in: query
          required: false
          description: Substring search on body field.
          schema: { type: string }
        - name: group
          in: query
          required: false
          description: Filter by group (exact match).
          schema: { type: string }
        - name: priority_min
          in: query
          required: false
          description: Minimum priority (1-5).
          schema: { type: integer, minimum: 1, maximum: 5 }
        - name: priority_max
          in: query
          required: false
          description: Maximum priority (1-5).
          schema: { type: integer, minimum: 1, maximum: 5 }
        - name: tag
          in: query
          required: false
          description: Filter by tag (message must have this tag).
          schema: { type: string }
        - name: from
          in: query
          required: false
          schema: { type: string, format: date-time }
        - name: to
          in: query
          required: false
          schema: { type: string, format: date-time }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  messages:
                    type: array
                    items: { $ref: "#/components/schemas/MessageSummary" }
                required: [messages]
  /api/messages/batch-delete:
    post:
      tags: [messages]
      security: [{ bearerAuth: [] }]
      summary: Batch delete messages older than N days
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/BatchDeleteRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/BatchDeleteResponse" }
  /api/messages/{id}:
    get:
      tags: [messages]
      security: [{ bearerAuth: [] }]
      summary: Get message detail
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  message: { $ref: "#/components/schemas/MessageDetail" }
                required: [message]
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
    delete:
      tags: [messages]
      security: [{ bearerAuth: [] }]
      summary: Delete a message (soft delete)
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "204":
          description: Deleted
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/channels:
    get:
      tags: [channels]
      security: [{ bearerAuth: [] }]
      summary: List channels
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  channels:
                    type: array
                    items: { $ref: "#/components/schemas/Channel" }
                required: [channels]
    post:
      tags: [channels]
      security: [{ bearerAuth: [] }]
      summary: Create a channel
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ChannelUpsertRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ChannelDetail" }
  /api/channels/{id}:
    get:
      tags: [channels]
      security: [{ bearerAuth: [] }]
      summary: Get channel detail
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ChannelDetail" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
    patch:
      tags: [channels]
      security: [{ bearerAuth: [] }]
      summary: Update a channel
      parameters:
        - $ref: "#/components/parameters/IdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ChannelUpsertRequest" }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ChannelDetail" }
    delete:
      tags: [channels]
      security: [{ bearerAuth: [] }]
      summary: Delete a channel
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "204":
          description: Deleted
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/channels/{id}/test:
    post:
      tags: [channels]
      security: [{ bearerAuth: [] }]
      summary: Send a test notification to a channel
      parameters:
        - $ref: "#/components/parameters/IdParam"
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ChannelTestRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ChannelTestResponse" }
        "400":
          description: Invalid request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/rules:
    get:
      tags: [rules]
      security: [{ bearerAuth: [] }]
      summary: List rules
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  rules:
                    type: array
                    items: { $ref: "#/components/schemas/Rule" }
                required: [rules]
    post:
      tags: [rules]
      security: [{ bearerAuth: [] }]
      summary: Create rule
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RuleUpsertRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  rule: { $ref: "#/components/schemas/Rule" }
                required: [rule]
  /api/rules/test:
    post:
      tags: [rules]
      security: [{ bearerAuth: [] }]
      summary: Test which rules would trigger for a sample message
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RuleTestRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RulesTestResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/rules/{id}:
    get:
      tags: [rules]
      security: [{ bearerAuth: [] }]
      summary: Get rule
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  rule: { $ref: "#/components/schemas/Rule" }
                required: [rule]
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
    patch:
      tags: [rules]
      security: [{ bearerAuth: [] }]
      summary: Update rule
      parameters:
        - $ref: "#/components/parameters/IdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RuleUpsertRequest" }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  rule: { $ref: "#/components/schemas/Rule" }
                required: [rule]
    delete:
      tags: [rules]
      security: [{ bearerAuth: [] }]
      summary: Delete rule
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "204":
          description: Deleted
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/rules/{id}/test:
    post:
      tags: [rules]
      security: [{ bearerAuth: [] }]
      summary: Test rule against a sample message (no send)
      parameters:
        - $ref: "#/components/parameters/IdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RuleTestRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RuleTestResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/messages/{id}/deliveries:
    get:
      tags: [deliveries]
      security: [{ bearerAuth: [] }]
      summary: List deliveries for a message
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  deliveries:
                    type: array
                    items: { $ref: "#/components/schemas/Delivery" }
                required: [deliveries]
